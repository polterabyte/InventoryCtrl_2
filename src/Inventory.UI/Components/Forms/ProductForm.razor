@using Microsoft.AspNetCore.Components.Forms
@using Inventory.Shared.DTOs
@using Inventory.Shared.Interfaces
@inject IProductService ProductService
@inject ICategoryService CategoryService
@inject IManufacturerService ManufacturerService
@inject IProductModelService ProductModelService
@inject IProductGroupService ProductGroupService
@inject IUnitOfMeasureApiService UnitOfMeasureService

<h3>@Title</h3>

    <RadzenTemplateForm Data="productModel" Submit="@(async (CreateProductDto model) => await HandleSubmit())">
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <Radzen.Blazor.RadzenFormField Text="Название товара:" class="rz-mb-3">
                    <RadzenTextBox @bind-Value="productModel.Name" Name="productName" />
                    <RadzenRequiredValidator Component="productName" Text="Название товара обязательно" />
                </Radzen.Blazor.RadzenFormField>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenFormField Text="SKU:" class="rz-mb-3">
                    <RadzenTextBox @bind-Value="productModel.SKU" Name="productSku" />
                    <RadzenRequiredValidator Component="productSku" Text="SKU обязательно" />
                </RadzenFormField>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <RadzenFormField Text="Описание:" class="rz-mb-3">
            <RadzenTextArea @bind-Value="productModel.Description" Rows="3" Name="description" />
        </RadzenFormField>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenFormField Text="Категория:" class="rz-mb-3">
                    <RadzenDropDown @bind-Value="productModel.CategoryId" 
                                   Data="@categories" 
                                   ValueProperty="Id" 
                                   TextProperty="Name"
                                   Placeholder="Выберите категорию"
                                   Name="categoryId" />
                </RadzenFormField>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenFormField Text="Производитель:" class="rz-mb-3">
                    <RadzenDropDown @bind-Value="productModel.ManufacturerId" 
                                   @bind-Value:after="@OnManufacturerChanged"
                                   Data="@manufacturers" 
                                   ValueProperty="Id" 
                                   TextProperty="Name"
                                   Placeholder="Выберите производителя"
                                   Name="manufacturerId" />
                </RadzenFormField>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenFormField Text="Модель товара:" class="rz-mb-3">
                    <RadzenDropDown @bind-Value="productModel.ProductModelId" 
                                   Data="@productModels" 
                                   ValueProperty="Id" 
                                   TextProperty="Name"
                                   Placeholder="Выберите модель"
                                   Name="productModelId" />
                </RadzenFormField>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenFormField Text="Группа товара:" class="rz-mb-3">
                    <RadzenDropDown @bind-Value="productModel.ProductGroupId" 
                                   Data="@productGroups" 
                                   ValueProperty="Id" 
                                   TextProperty="Name"
                                   Placeholder="Выберите группу"
                                   Name="productGroupId" />
                </RadzenFormField>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenFormField Text="Единица измерения:" class="rz-mb-3">
                    <RadzenDropDown @bind-Value="productModel.UnitOfMeasureId" 
                                   Data="@unitOfMeasures" 
                                   ValueProperty="Id" 
                                   TextProperty="Name"
                                   Placeholder="Выберите единицу измерения"
                                   Name="unitOfMeasureId" />
                </RadzenFormField>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" class="rz-mt-4">
                    <RadzenCheckBox @bind-Value="productModel.IsActive" Name="isActive" />
                    <RadzenLabel Text="Активный товар" For="isActive" />
                </RadzenStack>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenFormField Text="Минимальный остаток:" class="rz-mb-3">
                    <RadzenNumeric @bind-Value="productModel.MinStock" Name="minStock" />
                </RadzenFormField>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <RadzenFormField Text="Максимальный остаток:" class="rz-mb-3">
                    <RadzenNumeric @bind-Value="productModel.MaxStock" Name="maxStock" />
                </RadzenFormField>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <RadzenFormField Text="Примечание:" class="rz-mb-3">
            <RadzenTextArea @bind-Value="productModel.Note" Rows="2" Name="note" />
        </RadzenFormField>
    </div>

    <div class="mb-3">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Text="@(isLoading ? "Сохранение..." : SubmitButtonText)" 
                         ButtonStyle="ButtonStyle.Primary" 
                         ButtonType="ButtonType.Submit" 
                         Disabled="@isLoading" />
            <RadzenButton Text="Отмена" 
                         ButtonStyle="ButtonStyle.Light" 
                         Variant="Variant.Outlined" 
                         @onclick="OnCancel" />
        </RadzenStack>
    </div>
</RadzenTemplateForm>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" ShowIcon="true" class="rz-mt-3">
        @errorMessage
    </RadzenAlert>
}

@code {
    [Parameter] public string Title { get; set; } = "Товар";
    [Parameter] public CreateProductDto? InitialProduct { get; set; }
    [Parameter] public EventCallback<ProductDto> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private CreateProductDto productModel = new();
    private List<CategoryDto> categories = new();
    private List<ManufacturerDto> manufacturers = new();
    private List<ProductModelDto> productModels = new();
    private List<ProductGroupDto> productGroups = new();
    private List<UnitOfMeasureDto> unitOfMeasures = new();
    private string? errorMessage;
    private bool isLoading = false;

    private string SubmitButtonText => InitialProduct == null ? "Создать товар" : "Обновить товар";

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceData();
        
        if (InitialProduct != null)
        {
            productModel = InitialProduct;
        }
    }

    private async Task LoadReferenceData()
    {
        try
        {
            categories = await CategoryService.GetAllCategoriesAsync();
            manufacturers = await ManufacturerService.GetAllManufacturersAsync();
            productModels = await ProductModelService.GetAllProductModelsAsync();
            productGroups = await ProductGroupService.GetAllProductGroupsAsync();
            var unitOfMeasuresResponse = await UnitOfMeasureService.GetAllAsync();
            unitOfMeasures = unitOfMeasuresResponse.Data ?? new List<UnitOfMeasureDto>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка загрузки справочников: {ex.Message}";
        }
    }

    private async Task OnManufacturerChanged()
    {
        if (productModel.ManufacturerId > 0)
        {
            try
            {
                productModels = await ProductModelService.GetProductModelsByManufacturerAsync(productModel.ManufacturerId);
                productModel.ProductModelId = 0; // Reset model selection
                StateHasChanged();
            }
            catch (Exception ex)
            {
                errorMessage = $"Ошибка загрузки моделей: {ex.Message}";
            }
        }
        else
        {
            productModels = new List<ProductModelDto>();
            productModel.ProductModelId = 0;
            StateHasChanged();
        }
    }

    private async Task HandleSubmit()
    {
        errorMessage = null;
        isLoading = true;

        try
        {
            if (InitialProduct == null)
            {
                var result = await ProductService.CreateProductAsync(productModel);
                await OnSave.InvokeAsync(result);
            }
            else
            {
                // TODO: Implement update functionality
                // var updateDto = new UpdateProductDto { ... };
                // var result = await ProductService.UpdateProductAsync(productId, updateDto);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка сохранения: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
