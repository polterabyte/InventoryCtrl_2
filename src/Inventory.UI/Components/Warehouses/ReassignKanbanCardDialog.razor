@using Inventory.Shared.DTOs
@using Inventory.Shared.Interfaces
@inject IWarehouseService WarehouseService
@inject IKanbanCardService KanbanCardService
@inject Inventory.Shared.Services.IErrorHandlingService ErrorHandlingService
@inject Radzen.DialogService DialogService

@code {
    [Parameter] public KanbanCardDto Card { get; set; } = null!;
    [Parameter] public int CurrentWarehouseId { get; set; }

    private List<WarehouseDto> availableWarehouses = new();
    private WarehouseDto? selectedWarehouse;
    private bool saving;

    protected override async Task OnInitializedAsync()
    {
        availableWarehouses = (await WarehouseService.GetAllWarehousesAsync())
            .Where(w => w.IsActive && w.Id != CurrentWarehouseId)
            .OrderBy(w => w.Name)
            .ToList();
    }

    private async Task SaveAsync()
    {
        if (selectedWarehouse == null) return;

        saving = true;
        try
        {
            var success = await KanbanCardService.ReassignAsync(Card.Id, selectedWarehouse.Id);
            if (success)
            {
                DialogService.Close(true);
            }
            else
            {
                // Handle reassignment failure
                await ErrorHandlingService.HandleErrorAsync(
                    new Exception("Reassignment failed"), "Reassign Kanban Card",
                    new { CardId = Card.Id, NewWarehouseId = selectedWarehouse.Id });
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingService.HandleErrorAsync(ex, "Reassign Kanban Card",
                new { CardId = Card.Id, NewWarehouseId = selectedWarehouse?.Id });
        }
        finally
        {
            saving = false;
        }
    }

    private void Cancel() => DialogService.Close(false);
}

<RadzenStack Orientation="Orientation.Vertical" Gap="0.75rem">
    <RadzenText TextStyle="TextStyle.H6">Переместить канбан-карту</RadzenText>

    <RadzenCard>
        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
            <RadzenText TextStyle="TextStyle.Body2">
                <strong>Товар:</strong> @Card?.ProductName
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2">
                <strong>Текущий склад:</strong> @Card?.WarehouseName
            </RadzenText>
        </RadzenStack>
    </RadzenCard>

    <RadzenDropDown Data="@availableWarehouses"
                    TextProperty="Name"
                    @bind-Value="selectedWarehouse"
                    Placeholder="Выберите новый склад" />

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        <RadzenButton Text="Отмена" Click="@Cancel" />
        <RadzenButton Text="Переместить"
                      ButtonStyle="ButtonStyle.Primary"
                      Disabled="@(saving || selectedWarehouse == null)"
                      Click="@SaveAsync" />
    </RadzenStack>
</RadzenStack>