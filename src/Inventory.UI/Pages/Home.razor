@page "/"
@attribute [Authorize]
@using System.Security.Claims
@using Inventory.UI.Utilities
@using Inventory.Shared.Components
@using Inventory.Shared.Resources
@using Inventory.Shared.DTOs
@using Inventory.Shared.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Localization
@using Radzen
@using Radzen.Blazor
@inherits LocalizedComponentBase

@inject IDashboardService DashboardService
@inject NavigationManager NavigationManager

<PageTitle>@GetString("Navigation.Home")</PageTitle>

<RadzenStack Orientation="Orientation.Vertical"
                Gap="@RadzenUi.GapLarge"
                class="dashboard-layout">

    <RadzenStack Orientation="Orientation.Horizontal"
                    AlignItems="AlignItems.Center"
                    JustifyContent="JustifyContent.SpaceBetween"
                    class="section-header">
        <RadzenText TextStyle="TextStyle.H6">@GetString("Dashboard.KeyMetrics")</RadzenText>
    </RadzenStack>

    <RadzenRow Class="dashboard-kpi-grid g-3">
        <RadzenColumn Size="@ColumnFullSize">
            <StatsWidget Label="@GetString("Stats.TotalProducts")"
                            Value="@dashboardStats.TotalProducts"
                            Icon="inventory_2"
                            CardClass="primary" />
        </RadzenColumn>
        <RadzenColumn Size="@ColumnFullSize">
            <StatsWidget Label="@GetString("Stats.Categories")"
                            Value="@dashboardStats.TotalCategories"
                            Icon="category"
                            CardClass="info" />
        </RadzenColumn>
        <RadzenColumn Size="@ColumnFullSize">
            <StatsWidget Label="@GetString("Stats.Manufacturers")"
                            Value="@dashboardStats.TotalManufacturers"
                            Icon="precision_manufacturing"
                            CardClass="success" />
        </RadzenColumn>
        <RadzenColumn Size="@ColumnFullSize">
            <StatsWidget Label="@GetString("Stats.Warehouses")"
                            Value="@dashboardStats.TotalWarehouses"
                            Icon="storefront"
                            CardClass="primary" />
        </RadzenColumn>
        <RadzenColumn Size="@ColumnFullSize">
            <StatsWidget Label="@GetString("Stats.LowStock")"
                            Value="@dashboardStats.LowStockProducts"
                            SubLabel="@GetString("Stats.LowStockSubLabel")"
                            Icon="warning_amber"
                            CardClass="warning" />
        </RadzenColumn>
        <RadzenColumn Size="@ColumnFullSize">
            <StatsWidget Label="@GetString("Stats.OutOfStock")"
                            Value="@dashboardStats.OutOfStockProducts"
                            SubLabel="@GetString("Stats.OutOfStockSubLabel")"
                            Icon="remove_shopping_cart"
                            CardClass="danger" />
        </RadzenColumn>
    </RadzenRow>


    <RadzenRow Class="g-3">
        <RadzenColumn Size="@ColumnFullSize">
            <RecentActivity />
        </RadzenColumn>
        <RadzenColumn Size="@ColumnFullSize">
            <LowStockAlert />
        </RadzenColumn>
    </RadzenRow>

    <RadzenCard class="quick-actions-card">
        <RadzenStack Orientation="Orientation.Vertical" Gap="@RadzenUi.Gap">
            <RadzenStack Orientation="Orientation.Horizontal"
                            AlignItems="AlignItems.Center"
                            Gap="0.5rem">
                <RadzenIcon Icon="bolt" Style="color:var(--rz-primary);" />
                <RadzenText TextStyle="TextStyle.H6">@GetString("Dashboard.QuickActions")</RadzenText>
            </RadzenStack>

            <RadzenRow Class="quick-actions-grid g-3">
                <RadzenColumn Size="@ColumnFullSize">
                    <RadzenButton Text="@GetString("Action.AddProduct")"
                                    Icon="add_circle"
                                    ButtonStyle="ButtonStyle.Primary"
                                    Variant="Variant.Filled"
                                    Size="ButtonSize.Large"
                                    class="w-100"
                                    @onclick="NavigateToProducts" />
                </RadzenColumn>
                <RadzenColumn Size="@ColumnFullSize">
                    <RadzenButton Text="@GetString("Action.ProductIncome")"
                                    Icon="arrow_downward"
                                    ButtonStyle="ButtonStyle.Success"
                                    Variant="Variant.Filled"
                                    Size="ButtonSize.Large"
                                    class="w-100"
                                    @onclick="NavigateToProducts" />
                </RadzenColumn>
                <RadzenColumn Size="@ColumnFullSize">
                    <RadzenButton Text="@GetString("Action.ProductExpense")"
                                    Icon="arrow_upward"
                                    ButtonStyle="ButtonStyle.Warning"
                                    Variant="Variant.Filled"
                                    Size="ButtonSize.Large"
                                    class="w-100"
                                    @onclick="NavigateToProducts" />
                </RadzenColumn>
                <RadzenColumn Size="@ColumnFullSize">
                    <RadzenButton Text="@GetString("Action.Reports")"
                                    Icon="description"
                                    ButtonStyle="ButtonStyle.Info"
                                    Variant="Variant.Filled"
                                    Size="ButtonSize.Large"
                                    class="w-100"
                                    Disabled="true" />
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private const int ColumnFullSize = 12;
    private const int ColumnLargeSize = 8;
    private const int ColumnHalfSize = 6;
    private const int ColumnThirdSize = 4;
    private const int ColumnQuarterSize = 3;

    private DashboardStatsDto dashboardStats = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardStats();
    }

    private static string GetUserDisplayName(ClaimsPrincipal user)
    {
        var name = user.Identity?.Name;
        return string.IsNullOrWhiteSpace(name) ? "administrator" : name!;
    }

    private void NavigateToProducts()
    {
        NavigationManager.NavigateTo("/products");
    }

    private async Task LoadDashboardStats()
    {
        try
        {
            dashboardStats = await DashboardService.GetDashboardStatsAsync();
        }
        catch (Exception ex)
        {
            // Handle error - could show notification
            Console.WriteLine($"Error loading dashboard stats: {ex.Message}");
        }
    }
}
