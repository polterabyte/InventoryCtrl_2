@using Blazored.LocalStorage
@using Inventory.Shared.Resources
@using Microsoft.Extensions.Localization
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components.Routing

@inject AuthenticationStateProvider AuthStateProvider
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage
@inject IStringLocalizer<SharedResources> Localizer

<div class="sidebar-nav-container">
    <div class="sidebar-scroll">
        <nav class="sidebar-nav">
            @foreach (var link in GetMainLinks())
            {
                <NavLink class="sidebar-link"
                         href="@link.Path"
                         Match="@link.Match">
                    <RadzenIcon Icon="@link.Icon" class="sidebar-link__icon" />
                    <span>@link.Text</span>
                </NavLink>
            }
        </nav>

        <AuthorizeView Roles="Admin">
            <Authorized>
                <div class="sidebar-section">
                    <span class="sidebar-section__title">@Localizer["Navigation.Administration"]</span>
                    <nav class="sidebar-nav sidebar-nav--sub">
                        @foreach (var link in GetAdminLinks())
                        {
                            <NavLink class="sidebar-link sidebar-link--sub"
                                     href="@link.Path"
                                     Match="@link.Match">
                                <RadzenIcon Icon="@link.Icon" class="sidebar-link__icon" />
                                <span>@link.Text</span>
                            </NavLink>
                        }
                    </nav>
                </div>
            </Authorized>
        </AuthorizeView>
    </div>

    <div class="sidebar-footer">
        <RadzenButton Text="@Localizer[\"Action.Logout\"]"
                      Icon="logout"
                      ButtonStyle="ButtonStyle.Danger"
                      Variant="Variant.Outlined"
                      Size="ButtonSize.Medium"
                      Class="sidebar-logout"
                      Click="LogoutAsync" />
    </div>
</div>

@code {
    private NavLinkItem[] GetMainLinks() => new[]
    {
        new(Localizer["Navigation.Home"], "home", "/", NavLinkMatch.All),
        new(Localizer["Navigation.Catalog"], "inventory_2", "products"),
        new(Localizer["Navigation.Warehouses"], "warehouse", "warehouses"),
        new(Localizer["Navigation.Requests"], "assignment", "requests"),
        new(Localizer["Navigation.Reports"], "insights", "reports")
    };

    private NavLinkItem[] GetAdminLinks() => new[]
    {
        new(Localizer["Navigation.ReferenceData"], "settings", "admin/reference-data"),
        new(Localizer["Navigation.Users"], "group", "admin/users"),
        new(Localizer["Navigation.Audit"], "list_alt", "admin/audit-logs"),
        new(Localizer["Navigation.Debug"], "bug_report", "debug")
    };

    private async Task LogoutAsync()
    {
        try
        {
            var token = await LocalStorage.GetItemAsStringAsync("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                await AuthService.LogoutAsync(token);
            }

            await ClearAuthDataAsync();
            Navigation.NavigateTo("/login", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout error: {ex.Message}");
            await ClearAuthDataAsync();
            Navigation.NavigateTo("/login", true);
        }
    }

    private async Task ClearAuthDataAsync()
    {
        await LocalStorage.RemoveItemAsync("authToken");

        if (AuthStateProvider is ICustomAuthenticationStateProvider customProvider)
        {
            await customProvider.MarkUserAsLoggedOutAsync();
        }
    }

    private sealed record NavLinkItem(string Text, string Icon, string Path, NavLinkMatch Match = NavLinkMatch.Prefix);
}


