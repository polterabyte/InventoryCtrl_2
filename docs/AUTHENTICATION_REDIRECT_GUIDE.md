# Руководство по автоматическому перенаправлению на страницу входа

## Обзор

Данная система обеспечивает автоматическое перенаправление неавторизованных пользователей на страницу входа, используя лучшие практики безопасности и удобства использования.

## Компоненты системы

### 1. AuthenticationGuard.razor
Глобальный компонент для проверки аутентификации с поддержкой:
- Проверки валидности JWT токена
- Проверки ролей пользователя
- Автоматического перенаправления на страницу входа
- Сохранения исходного URL для возврата

### 2. AuthenticationService.cs
Сервис для управления аутентификацией:
- Проверка статуса аутентификации
- Валидация JWT токенов
- Управление URL для возврата
- Очистка данных аутентификации

### 3. ProtectedRoute.razor
Компонент для защиты маршрутов:
- Проверка аутентификации перед отображением контента
- Поддержка проверки ролей
- Автоматическое перенаправление

### 4. TokenExpirationHandler.razor
Обработчик истечения токенов:
- Периодическая проверка валидности токена
- Автоматическое уведомление об истечении сессии
- Сохранение текущего URL перед перенаправлением

### 5. AuthenticationMiddleware.cs
Middleware для серверной проверки:
- Проверка JWT токенов на сервере
- Защита API эндпоинтов
- Обработка неавторизованных запросов

## Как это работает

### Клиентская сторона (Blazor WebAssembly)

1. **При загрузке приложения:**
   - `TokenExpirationHandler` проверяет валидность токена
   - Если токен недействителен, пользователь перенаправляется на `/login`

2. **При навигации:**
   - `ProtectedRoute` проверяет аутентификацию для защищенных страниц
   - `AuthenticationGuard` обеспечивает дополнительную защиту

3. **При истечении токена:**
   - `TokenExpirationHandler` обнаруживает истечение
   - Сохраняет текущий URL в LocalStorage
   - Показывает уведомление пользователю
   - Перенаправляет на страницу входа

4. **После успешного входа:**
   - `Login.razor` получает сохраненный URL
   - Перенаправляет пользователя на исходную страницу

### Серверная сторона (API)

1. **Middleware проверки:**
   - `AuthenticationMiddleware` проверяет каждый запрос
   - Пропускает публичные эндпоинты (`/api/auth/login`, `/api/health`)
   - Валидирует JWT токены для защищенных эндпоинтов

2. **Обработка неавторизованных запросов:**
   - Возвращает HTTP 401 с JSON ответом
   - Логирует попытки неавторизованного доступа

## Настройка

### 1. Регистрация сервисов

В `Program.cs` добавлены следующие сервисы:

```csharp
// Регистрация сервиса аутентификации
builder.Services.AddScoped<IAuthenticationService, AuthenticationService>();

// Регистрация middleware
app.UseMiddleware<AuthenticationMiddleware>();
```

### 2. Использование в компонентах

```razor
@* Защита всего контента *@
<ProtectedRoute>
    <YourContent />
</ProtectedRoute>

@* Защита с проверкой ролей *@
<ProtectedRoute RequiredRoles="@(new[] { "Admin", "Manager" })">
    <AdminContent />
</ProtectedRoute>
```

### 3. Публичные эндпоинты

В `AuthenticationMiddleware.cs` настройте публичные эндпоинты:

```csharp
private bool IsPublicEndpoint(PathString path)
{
    var publicPaths = new[]
    {
        "/api/auth/login",
        "/api/auth/register",
        "/api/health",
        "/swagger"
    };
    return publicPaths.Any(publicPath => path.StartsWithSegments(publicPath));
}
```

## Безопасность

### 1. Проверка токенов
- Клиентская проверка для UX
- Серверная проверка для безопасности
- Проверка истечения с буфером времени

### 2. Защита от атак
- Валидация JWT подписи
- Проверка времени жизни токена
- Очистка недействительных токенов

### 3. Логирование
- Логирование попыток неавторизованного доступа
- Отслеживание ошибок аутентификации

## Уведомления пользователя

### 1. Toast уведомления
- Автоматические уведомления об истечении сессии
- Информативные сообщения об ошибках

### 2. Loading состояния
- Показ загрузки при проверке аутентификации
- Плавные переходы между состояниями

## Тестирование

### 1. Тест истечения токена
1. Войдите в систему
2. Измените время истечения токена в LocalStorage
3. Попробуйте выполнить действие
4. Убедитесь, что произошло перенаправление на `/login`

### 2. Тест прямого доступа к API
1. Откройте Developer Tools
2. Попробуйте выполнить запрос к защищенному API без токена
3. Убедитесь, что получен ответ 401

### 3. Тест возврата после входа
1. Перейдите на защищенную страницу без входа
2. Войдите в систему
3. Убедитесь, что произошло перенаправление на исходную страницу

## Устранение неполадок

### 1. Бесконечные перенаправления
- Проверьте, что страница входа не требует аутентификации
- Убедитесь, что публичные эндпоинты правильно настроены

### 2. Токен не сохраняется
- Проверьте настройки LocalStorage
- Убедитесь, что `CustomAuthenticationStateProvider` работает корректно

### 3. API возвращает 401
- Проверьте настройки JWT в `appsettings.json`
- Убедитесь, что токен передается в заголовке Authorization

## Лучшие практики

1. **Всегда проверяйте аутентификацию на сервере** - клиентская проверка только для UX
2. **Используйте HTTPS** - для защиты JWT токенов
3. **Настройте короткое время жизни токенов** - для повышения безопасности
4. **Реализуйте refresh токены** - для улучшения UX
5. **Логируйте события аутентификации** - для мониторинга безопасности
