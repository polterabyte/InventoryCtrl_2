# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: Push Notifications

## üéØ –û–±–∑–æ—Ä

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ browser push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Inventory Control System v2.

## üìã –¶–µ–ª–∏

- –û–±–µ—Å–ø–µ—á–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- –£–ª—É—á—à–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç —á–µ—Ä–µ–∑ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –û–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Blazor UI     ‚îÇ    ‚îÇ   Push Service  ‚îÇ    ‚îÇ   Browser       ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ   Service       ‚îÇ
‚îÇ - Subscribe UI  ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ - VAPID Keys    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   Worker        ‚îÇ
‚îÇ - Settings UI   ‚îÇ    ‚îÇ - Send Push     ‚îÇ    ‚îÇ - Handle Push   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ - Retry Logic   ‚îÇ    ‚îÇ - Show Toast    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Database      ‚îÇ    ‚îÇ   SignalR Hub   ‚îÇ    ‚îÇ   Push          ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ   Subscription  ‚îÇ
‚îÇ - Subscriptions ‚îÇ    ‚îÇ - Real-time     ‚îÇ    ‚îÇ   Storage       ‚îÇ
‚îÇ - User Prefs    ‚îÇ    ‚îÇ   Updates       ‚îÇ    ‚îÇ - Local Storage ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### NuGet –ø–∞–∫–µ—Ç—ã

```xml
<!-- Backend -->
<PackageReference Include="Microsoft.AspNetCore.WebPush" Version="1.0.11" />
<PackageReference Include="WebPush" Version="1.0.11" />

<!-- Frontend -->
<!-- –£–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç -->
<PackageReference Include="Microsoft.JSInterop" Version="9.0.0" />
```

### JavaScript –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

```json
{
  "dependencies": {
    "web-push": "^3.6.6"
  }
}
```

## üóÑ –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### PushSubscription Entity

```csharp
public class PushSubscription
{
    public int Id { get; set; }
    public string UserId { get; set; } = string.Empty;
    public string Endpoint { get; set; } = string.Empty;
    public string P256dhKey { get; set; } = string.Empty;
    public string AuthKey { get; set; } = string.Empty;
    public bool IsActive { get; set; } = true;
    public DateTime CreatedAt { get; set; }
    public DateTime LastUsedAt { get; set; }
    public string UserAgent { get; set; } = string.Empty;
    public string Browser { get; set; } = string.Empty;
    public string DeviceType { get; set; } = string.Empty;
}
```

### PushNotificationRequest DTO

```csharp
public class PushNotificationRequest
{
    public string Title { get; set; } = string.Empty;
    public string Body { get; set; } = string.Empty;
    public string Icon { get; set; } = string.Empty;
    public string Badge { get; set; } = string.Empty;
    public string Image { get; set; } = string.Empty;
    public string Tag { get; set; } = string.Empty;
    public bool RequireInteraction { get; set; } = false;
    public bool Silent { get; set; } = false;
    public int? Ttl { get; set; }
    public Dictionary<string, object> Data { get; set; } = new();
    public List<string> Actions { get; set; } = new();
}
```

## üîß –°–µ—Ä–≤–∏—Å—ã

### IPushNotificationService

```csharp
public interface IPushNotificationService
{
    Task<bool> SubscribeAsync(string userId, PushSubscriptionDto subscription);
    Task<bool> UnsubscribeAsync(string userId, string endpoint);
    Task<bool> SendToUserAsync(string userId, PushNotificationRequest request);
    Task<bool> SendToAllAsync(PushNotificationRequest request);
    Task<bool> SendToRoleAsync(string role, PushNotificationRequest request);
    Task<List<PushSubscriptionDto>> GetUserSubscriptionsAsync(string userId);
    Task<bool> IsSubscribedAsync(string userId);
    Task<PushSubscriptionStats> GetStatsAsync();
}
```

### PushNotificationService Implementation

```csharp
public class PushNotificationService : IPushNotificationService
{
    private readonly AppDbContext _context;
    private readonly ILogger<PushNotificationService> _logger;
    private readonly IHubContext<NotificationHub> _hubContext;
    private readonly WebPushClient _webPushClient;
    private readonly VapidDetails _vapidDetails;

    public PushNotificationService(
        AppDbContext context,
        ILogger<PushNotificationService> logger,
        IHubContext<NotificationHub> hubContext,
        IConfiguration configuration)
    {
        _context = context;
        _logger = logger;
        _hubContext = hubContext;
        _webPushClient = new WebPushClient();
        
        _vapidDetails = new VapidDetails(
            subject: configuration["PushNotifications:Subject"],
            publicKey: configuration["PushNotifications:PublicKey"],
            privateKey: configuration["PushNotifications:PrivateKey"]
        );
    }

    public async Task<bool> SubscribeAsync(string userId, PushSubscriptionDto subscription)
    {
        try
        {
            var existing = await _context.PushSubscriptions
                .FirstOrDefaultAsync(s => s.UserId == userId && s.Endpoint == subscription.Endpoint);

            if (existing != null)
            {
                existing.IsActive = true;
                existing.LastUsedAt = DateTime.UtcNow;
            }
            else
            {
                var newSubscription = new PushSubscription
                {
                    UserId = userId,
                    Endpoint = subscription.Endpoint,
                    P256dhKey = subscription.Keys.P256dh,
                    AuthKey = subscription.Keys.Auth,
                    CreatedAt = DateTime.UtcNow,
                    LastUsedAt = DateTime.UtcNow,
                    UserAgent = subscription.UserAgent ?? string.Empty,
                    Browser = subscription.Browser ?? string.Empty,
                    DeviceType = subscription.DeviceType ?? string.Empty
                };

                _context.PushSubscriptions.Add(newSubscription);
            }

            await _context.SaveChangesAsync();
            
            // –£–≤–µ–¥–æ–º–∏—Ç—å —á–µ—Ä–µ–∑ SignalR –æ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–µ
            await _hubContext.Clients.User(userId).SendAsync("PushSubscriptionUpdated", true);
            
            return true;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to subscribe user {UserId} to push notifications", userId);
            return false;
        }
    }

    public async Task<bool> SendToUserAsync(string userId, PushNotificationRequest request)
    {
        try
        {
            var subscriptions = await _context.PushSubscriptions
                .Where(s => s.UserId == userId && s.IsActive)
                .ToListAsync();

            var successCount = 0;
            foreach (var subscription in subscriptions)
            {
                try
                {
                    var pushSubscription = new WebPush.PushSubscription(
                        subscription.Endpoint,
                        subscription.P256dhKey,
                        subscription.AuthKey
                    );

                    var payload = JsonSerializer.Serialize(new
                    {
                        title = request.Title,
                        body = request.Body,
                        icon = request.Icon,
                        badge = request.Badge,
                        image = request.Image,
                        tag = request.Tag,
                        requireInteraction = request.RequireInteraction,
                        silent = request.Silent,
                        data = request.Data,
                        actions = request.Actions
                    });

                    await _webPushClient.SendNotificationAsync(
                        pushSubscription,
                        payload,
                        _vapidDetails
                    );

                    subscription.LastUsedAt = DateTime.UtcNow;
                    successCount++;
                }
                catch (WebPushException ex) when (ex.StatusCode == HttpStatusCode.Gone || ex.StatusCode == HttpStatusCode.NotFound)
                {
                    // –ü–æ–¥–ø–∏—Å–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞
                    subscription.IsActive = false;
                    _logger.LogWarning("Push subscription for user {UserId} is no longer valid", userId);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Failed to send push notification to user {UserId}", userId);
                }
            }

            await _context.SaveChangesAsync();
            return successCount > 0;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to send push notifications to user {UserId}", userId);
            return false;
        }
    }

    // –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã...
}
```

## üåê API Endpoints

### PushSubscriptionController

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class PushSubscriptionController : ControllerBase
{
    private readonly IPushNotificationService _pushService;
    private readonly ILogger<PushSubscriptionController> _logger;

    [HttpPost("subscribe")]
    public async Task<IActionResult> Subscribe([FromBody] PushSubscriptionDto subscription)
    {
        try
        {
            var userId = GetCurrentUserId();
            if (string.IsNullOrEmpty(userId))
            {
                return Unauthorized();
            }

            var result = await _pushService.SubscribeAsync(userId, subscription);
            return Ok(new ApiResponse<bool>
            {
                Success = result,
                Data = result
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to subscribe user to push notifications");
            return StatusCode(500, new ApiResponse<bool>
            {
                Success = false,
                ErrorMessage = "Internal server error"
            });
        }
    }

    [HttpPost("unsubscribe")]
    public async Task<IActionResult> Unsubscribe([FromBody] UnsubscribeRequest request)
    {
        try
        {
            var userId = GetCurrentUserId();
            if (string.IsNullOrEmpty(userId))
            {
                return Unauthorized();
            }

            var result = await _pushService.UnsubscribeAsync(userId, request.Endpoint);
            return Ok(new ApiResponse<bool>
            {
                Success = result,
                Data = result
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to unsubscribe user from push notifications");
            return StatusCode(500, new ApiResponse<bool>
            {
                Success = false,
                ErrorMessage = "Internal server error"
            });
        }
    }

    [HttpGet("status")]
    public async Task<IActionResult> GetSubscriptionStatus()
    {
        try
        {
            var userId = GetCurrentUserId();
            if (string.IsNullOrEmpty(userId))
            {
                return Unauthorized();
            }

            var isSubscribed = await _pushService.IsSubscribedAsync(userId);
            var subscriptions = await _pushService.GetUserSubscriptionsAsync(userId);

            return Ok(new ApiResponse<object>
            {
                Success = true,
                Data = new
                {
                    IsSubscribed = isSubscribed,
                    Subscriptions = subscriptions
                }
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get push subscription status");
            return StatusCode(500, new ApiResponse<object>
            {
                Success = false,
                ErrorMessage = "Internal server error"
            });
        }
    }

    private string? GetCurrentUserId()
    {
        return User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    }
}
```

## üé® Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### PushNotificationManager.razor

```razor
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject IPushNotificationApiService PushApiService
@inject ILogger<PushNotificationManager> Logger

<div class="push-notification-settings">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" @bind="isPushEnabled" 
               @onchange="HandlePushToggle" id="pushNotifications">
        <label class="form-check-label" for="pushNotifications">
            –†–∞–∑—Ä–µ—à–∏—Ç—å push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </label>
    </div>
    
    @if (isPushEnabled && !isSubscribed)
    {
        <button class="btn btn-primary btn-sm mt-2" @onclick="SubscribeToPush">
            –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
    }
    
    @if (isSubscribed)
    {
        <div class="alert alert-success mt-2">
            <i class="fas fa-check-circle"></i>
            Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã
        </div>
        <button class="btn btn-outline-danger btn-sm mt-2" @onclick="UnsubscribeFromPush">
            –û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
    }
    
    @if (browserSupport == PushSupport.NotSupported)
    {
        <div class="alert alert-warning mt-2">
            <i class="fas fa-exclamation-triangle"></i>
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </div>
    }
</div>

@code {
    private bool isPushEnabled = false;
    private bool isSubscribed = false;
    private PushSupport browserSupport = PushSupport.Unknown;
    private string? currentEndpoint;

    protected override async Task OnInitializedAsync()
    {
        await CheckBrowserSupport();
        await CheckSubscriptionStatus();
    }

    private async Task CheckBrowserSupport()
    {
        try
        {
            browserSupport = await JSRuntime.InvokeAsync<PushSupport>("PushNotifications.checkSupport");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to check browser support for push notifications");
            browserSupport = PushSupport.NotSupported;
        }
    }

    private async Task CheckSubscriptionStatus()
    {
        try
        {
            var response = await PushApiService.GetSubscriptionStatusAsync();
            if (response.Success && response.Data != null)
            {
                isSubscribed = response.Data.IsSubscribed;
                currentEndpoint = response.Data.Subscriptions?.FirstOrDefault()?.Endpoint;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to check push subscription status");
        }
    }

    private async Task HandlePushToggle(ChangeEventArgs e)
    {
        isPushEnabled = (bool)e.Value!;
        if (isPushEnabled && browserSupport == PushSupport.Supported)
        {
            await SubscribeToPush();
        }
    }

    private async Task SubscribeToPush()
    {
        try
        {
            var subscription = await JSRuntime.InvokeAsync<PushSubscriptionDto>("PushNotifications.subscribe");
            if (subscription != null)
            {
                var response = await PushApiService.SubscribeAsync(subscription);
                if (response.Success)
                {
                    isSubscribed = true;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to subscribe to push notifications");
        }
    }

    private async Task UnsubscribeFromPush()
    {
        try
        {
            if (!string.IsNullOrEmpty(currentEndpoint))
            {
                var response = await PushApiService.UnsubscribeAsync(currentEndpoint);
                if (response.Success)
                {
                    isSubscribed = false;
                    currentEndpoint = null;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to unsubscribe from push notifications");
        }
    }

    public enum PushSupport
    {
        Unknown,
        Supported,
        NotSupported
    }
}
```

## üì± Service Worker

### sw.js

```javascript
const CACHE_NAME = 'inventory-control-v1';
const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY';

// Install event
self.addEventListener('install', (event) => {
    console.log('Service Worker installing...');
    self.skipWaiting();
});

// Activate event
self.addEventListener('activate', (event) => {
    console.log('Service Worker activating...');
    event.waitUntil(self.clients.claim());
});

// Push event
self.addEventListener('push', (event) => {
    console.log('Push notification received:', event);
    
    let notificationData = {
        title: 'Inventory Control',
        body: 'You have a new notification',
        icon: '/icon-192.png',
        badge: '/icon-192.png',
        tag: 'inventory-notification',
        requireInteraction: false,
        data: {}
    };

    if (event.data) {
        try {
            const pushData = event.data.json();
            notificationData = { ...notificationData, ...pushData };
        } catch (e) {
            console.error('Failed to parse push data:', e);
        }
    }

    event.waitUntil(
        self.registration.showNotification(notificationData.title, notificationData)
    );
});

// Notification click event
self.addEventListener('notificationclick', (event) => {
    console.log('Notification clicked:', event);
    
    event.notification.close();

    const clickAction = event.action;
    const notificationData = event.notification.data;

    event.waitUntil(
        self.clients.matchAll({ type: 'window', includeUncontrolled: true })
            .then((clientList) => {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ–µ –æ–∫–Ω–æ, —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –Ω–µ–º
                for (const client of clientList) {
                    if (client.url.includes(self.location.origin) && 'focus' in client) {
                        return client.focus();
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –æ–∫–Ω–∞, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ
                if (self.clients.openWindow) {
                    let url = '/';
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –¥–µ–π—Å—Ç–≤–∏–∏, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    if (notificationData && notificationData.actionUrl) {
                        url = notificationData.actionUrl;
                    }
                    
                    return self.clients.openWindow(url);
                }
            })
    );
});

// Background sync (–¥–ª—è –±—É–¥—É—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π)
self.addEventListener('sync', (event) => {
    console.log('Background sync event:', event);
    
    if (event.tag === 'notification-sync') {
        event.waitUntil(doBackgroundSync());
    }
});

async function doBackgroundSync() {
    // –õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    console.log('Performing background sync...');
}
```

## üîê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### appsettings.json

```json
{
  "PushNotifications": {
    "Subject": "mailto:admin@inventorycontrol.com",
    "PublicKey": "YOUR_VAPID_PUBLIC_KEY",
    "PrivateKey": "YOUR_VAPID_PRIVATE_KEY",
    "Enabled": true,
    "MaxRetries": 3,
    "RetryDelay": 5000
  }
}
```

### Program.cs —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤

```csharp
// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è push notification —Å–µ—Ä–≤–∏—Å–∞
builder.Services.AddScoped<IPushNotificationService, PushNotificationService>();

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VAPID
builder.Services.Configure<PushNotificationOptions>(
    builder.Configuration.GetSection("PushNotifications"));

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ CORS –¥–ª—è push notifications
builder.Services.AddCors(options =>
{
    options.AddPolicy("PushNotifications", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

```csharp
public class PushNotificationServiceTests : TestBase
{
    [Fact]
    public async Task SubscribeAsync_ValidSubscription_ShouldReturnTrue()
    {
        // Arrange
        var userId = "test-user";
        var subscription = new PushSubscriptionDto
        {
            Endpoint = "https://fcm.googleapis.com/fcm/send/test",
            Keys = new PushKeysDto
            {
                P256dh = "test-p256dh-key",
                Auth = "test-auth-key"
            }
        };

        // Act
        var result = await _pushService.SubscribeAsync(userId, subscription);

        // Assert
        Assert.True(result);
    }

    [Fact]
    public async Task SendToUserAsync_ValidUser_ShouldSendNotification()
    {
        // Arrange
        var userId = "test-user";
        var request = new PushNotificationRequest
        {
            Title = "Test Notification",
            Body = "This is a test notification"
        };

        // Act
        var result = await _pushService.SendToUserAsync(userId, request);

        // Assert
        Assert.True(result);
    }
}
```

### Integration —Ç–µ—Å—Ç—ã

```csharp
public class PushSubscriptionControllerTests : IClassFixture<WebApplicationFactory<Program>>
{
    [Fact]
    public async Task Subscribe_WithValidData_ShouldReturnSuccess()
    {
        // Arrange
        var client = _factory.CreateClient();
        var subscription = new PushSubscriptionDto
        {
            Endpoint = "https://fcm.googleapis.com/fcm/send/test",
            Keys = new PushKeysDto
            {
                P256dh = "test-p256dh-key",
                Auth = "test-auth-key"
            }
        };

        // Act
        var response = await client.PostAsJsonAsync("/api/pushsubscription/subscribe", subscription);

        // Assert
        response.EnsureSuccessStatusCode();
    }
}
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

```csharp
public class PushNotificationMetrics
{
    public int TotalSubscriptions { get; set; }
    public int ActiveSubscriptions { get; set; }
    public int NotificationsSent { get; set; }
    public int NotificationsDelivered { get; set; }
    public int NotificationsFailed { get; set; }
    public double DeliveryRate { get; set; }
    public Dictionary<string, int> BrowserStats { get; set; } = new();
    public Dictionary<string, int> DeviceTypeStats { get; set; } = new();
}
```

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ NotificationService

```csharp
public class NotificationService : INotificationService
{
    private readonly IPushNotificationService _pushService;
    // ... –¥—Ä—É–≥–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

    public async Task<bool> CreateNotificationAsync(CreateNotificationRequest request)
    {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        var notification = await CreateNotificationInDatabase(request);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ SignalR
        await SendViaSignalR(notification);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        await SendPushNotification(notification);
        
        return true;
    }

    private async Task SendPushNotification(NotificationDto notification)
    {
        try
        {
            var pushRequest = new PushNotificationRequest
            {
                Title = notification.Title,
                Body = notification.Message,
                Icon = "/icon-192.png",
                Badge = "/icon-192.png",
                Tag = $"notification-{notification.Id}",
                Data = new Dictionary<string, object>
                {
                    ["notificationId"] = notification.Id,
                    ["type"] = notification.Type,
                    ["category"] = notification.Category,
                    ["actionUrl"] = notification.ActionUrl ?? ""
                }
            };

            await _pushService.SendToUserAsync(notification.UserId, pushRequest);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to send push notification for notification {NotificationId}", notification.Id);
        }
    }
}
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –®–∞–≥–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è VAPID –∫–ª—é—á–µ–π**:
```bash
npx web-push generate-vapid-keys
```

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**:
   - –î–æ–±–∞–≤–∏—Ç—å VAPID –∫–ª—é—á–∏ –≤ appsettings.json
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –¥–ª—è push notifications

3. **–ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**:
```bash
dotnet ef migrations add AddPushSubscriptions
dotnet ef database update
```

4. **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Service Worker**:
   - –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å sw.js –≤ wwwroot
   - –û–±–Ω–æ–≤–∏—Ç—å index.html –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW

5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–∫–æ–≤

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–∞–Ω–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é browser push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ.

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: $(Get-Date)*  
*–í–µ—Ä—Å–∏—è: 1.0*  
*–°—Ç–∞—Ç—É—Å: Ready for Implementation*
