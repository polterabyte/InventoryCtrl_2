# –§–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ JWT —Ç–æ–∫–µ–Ω–æ–≤ –≤ Docker API

## üìã –†–ï–ó–Æ–ú–ï –ü–†–û–ë–õ–ï–ú–´

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ JWT —Ç–æ–∫–µ–Ω—ã, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –æ—à–∏–±–∫–∞–º 401 –≤ –ª–æ–≥–∞—Ö API.

**–ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã**: 
- JWT —Ç–æ–∫–µ–Ω—ã –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç
- –ö–ª–∏–µ–Ω—Ç –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ 401 –æ—à–∏–±–æ–∫ –¥–ª—è refresh —Ç–æ–∫–µ–Ω–æ–≤

## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### 1. –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–†–ê–ë–û–¢–ê–ï–¢ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û)
```
Web Client ‚Üí API Server
    ‚îÇ           ‚îÇ
    ‚îÇ           ‚îú‚îÄ JWT Token (15 min) ‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
    ‚îÇ           ‚îú‚îÄ Refresh Token (7 days) ‚úÖ –•–æ—Ä–æ—à–æ
    ‚îÇ           ‚îî‚îÄ 401 –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
    ‚îÇ
    ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã ‚úÖ
    ‚îú‚îÄ –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è ‚ùå
    ‚îú‚îÄ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã ‚ùå
    ‚îî‚îÄ –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 401 ‚ùå
```

### 2. –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
- **–¢–∏–ø**: `SecurityTokenExpiredException`
- **–ö–æ–¥**: `IDX10223: Lifetime validation failed`
- **–ß–∞—Å—Ç–æ—Ç–∞**: –ö–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥
- **–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã**: `/api/dashboard/*`

### 3. –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚úÖ **API —Å—Ç–æ—Ä–æ–Ω–∞ –≥–æ—Ç–æ–≤–∞**:
- `RefreshTokenService.cs` - –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `AuthController.cs` - endpoint `/api/auth/refresh`
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

‚ùå **–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞**:
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ 401 –æ—à–∏–±–æ–∫
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è

## üöÄ –ü–õ–ê–ù –£–°–¢–†–ê–ù–ï–ù–ò–Ø

### –≠–¢–ê–ü 1: –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (0 –º–∏–Ω—É—Ç)
```bash
# 1. –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ
localStorage.removeItem('authToken');
localStorage.removeItem('refreshToken');
location.reload();

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-–∫–ª–∏–µ–Ω—Ç
docker restart inventory-web-staging
```

### –≠–¢–ê–ü 2: –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (15 –º–∏–Ω—É—Ç)
**–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é JWT**:
```json
// src/Inventory.API/appsettings.json
{
  "Jwt": {
    "ExpireMinutes": 60,  // –ë—ã–ª–æ: 15, –°—Ç–∞–ª–æ: 60
    "RefreshTokenExpireDays": 7
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–æ–∫–µ–Ω—ã –±—É–¥—É—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å 1 —á–∞—Å –≤–º–µ—Å—Ç–æ 15 –º–∏–Ω—É—Ç.

### –≠–¢–ê–ü 3: –ü–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (2-3 —á–∞—Å–∞)

#### 3.1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
**–§–∞–π–ª**: `src/Inventory.Web.Client/Services/WebBaseApiService.cs`

```csharp
private async Task<bool> IsTokenExpiringSoonAsync()
{
    var token = await _localStorage.GetItemAsStringAsync("authToken");
    if (string.IsNullOrEmpty(token)) return true;
    
    try
    {
        var payload = token.Split('.')[1];
        var jsonBytes = Convert.FromBase64String(payload);
        var claims = JsonSerializer.Deserialize<Dictionary<string, object>>(jsonBytes);
        
        if (claims?.ContainsKey("exp") == true)
        {
            var exp = long.Parse(claims["exp"].ToString()!);
            var expTime = DateTimeOffset.FromUnixTimeSeconds(exp);
            var timeUntilExpiry = expTime - DateTimeOffset.UtcNow;
            
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ—á–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç
            return timeUntilExpiry.TotalMinutes < 5;
        }
    }
    catch
    {
        return true; // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, —Å—á–∏—Ç–∞–µ–º –∏—Å—Ç–µ–∫—à–∏–º
    }
    
    return true;
}
```

#### 3.2. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
```csharp
private async Task<bool> TryRefreshTokenAsync()
{
    try
    {
        var refreshToken = await _localStorage.GetItemAsStringAsync("refreshToken");
        if (string.IsNullOrEmpty(refreshToken)) return false;
        
        var authService = _serviceProvider.GetRequiredService<IAuthService>();
        var result = await authService.RefreshTokenAsync(refreshToken);
        
        if (result.Success)
        {
            await _localStorage.SetItemAsStringAsync("authToken", result.Token);
            await _localStorage.SetItemAsStringAsync("refreshToken", result.RefreshToken);
            _httpClient.DefaultRequestHeaders.Authorization = 
                new AuthenticationHeaderValue("Bearer", result.Token);
            return true;
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to refresh token");
    }
    return false;
}
```

#### 3.3. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å 401 –æ—à–∏–±–∫–∏
```csharp
private async Task<T> HandleStandardResponseAsync<T>(HttpResponseMessage response)
{
    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 401, –ø–æ–ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
    if (response.StatusCode == HttpStatusCode.Unauthorized)
    {
        if (await TryRefreshTokenAsync())
        {
            // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
            return await ExecuteHttpRequestAsync<T>(/* –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã */);
        }
        else
        {
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ –ª–æ–≥–∏–Ω
            await RedirectToLoginAsync();
        }
    }
    
    // –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞...
}
```

#### 3.4. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
```csharp
protected async Task<T> ExecuteHttpRequestAsync<T>(/* –ø–∞—Ä–∞–º–µ—Ç—Ä—ã */)
{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–∞–µ—Ç –ª–∏ —Ç–æ–∫–µ–Ω
    if (await IsTokenExpiringSoonAsync())
    {
        await TryRefreshTokenAsync();
    }
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å...
}
```

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ü–æ—Å–ª–µ –≠–¢–ê–ü–ê 1 (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):
- ‚úÖ –û—à–∏–±–∫–∏ –∏—Å—á–µ–∑–Ω—É—Ç –∏–∑ –ª–æ–≥–æ–≤
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

### –ü–æ—Å–ª–µ –≠–¢–ê–ü–ê 2 (15 –º–∏–Ω—É—Ç):
- ‚úÖ –¢–æ–∫–µ–Ω—ã –¥–µ–π—Å—Ç–≤—É—é—Ç 1 —á–∞—Å
- ‚úÖ –ú–µ–Ω—å—à–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π —Å–µ—Å—Å–∏–∏

### –ü–æ—Å–ª–µ –≠–¢–ê–ü–ê 3 (2-3 —á–∞—Å–∞):
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- ‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
- ‚úÖ –ù–∞–¥–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø –≤ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: Refresh —Ç–æ–∫–µ–Ω—ã —É–∂–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
5. **–û—Ç–∫–∞—Ç**: –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´

1. **–í–´–°–û–ö–ò–ô**: –≠–¢–ê–ü 1 - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
2. **–í–´–°–û–ö–ò–ô**: –≠–¢–ê–ü 2 - —É–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–æ–≤
3. **–°–†–ï–î–ù–ò–ô**: –≠–¢–ê–ü 3 - –ø–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–∞–µ–º–∞ –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. API —Å—Ç–æ—Ä–æ–Ω–∞ —É–∂–µ –≥–æ—Ç–æ–≤–∞, –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —á–∞—Å—Ç—å. –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö.
