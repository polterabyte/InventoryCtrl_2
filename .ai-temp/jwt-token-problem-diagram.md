# Диаграмма проблемы JWT токенов

## Текущая ситуация (ПРОБЛЕМА)

```
┌─────────────────┐    JWT Token (15 min)    ┌─────────────────┐
│   Web Client    │ ────────────────────────► │   API Server    │
│                 │                           │                 │
│ - Сохраняет     │                           │ - Валидирует    │
│   токен в       │                           │   токен         │
│   localStorage  │                           │ - Возвращает    │
│                 │                           │   401 при       │
│ - НЕ обновляет  │                           │   истечении     │
│   токен         │                           │                 │
│                 │                           │                 │
│ - НЕ обрабатывает◄─────────────────────────│                 │
│   401 ошибки    │       401 Unauthorized    │                 │
└─────────────────┘                           └─────────────────┘
        │
        ▼
   ❌ ПОЛЬЗОВАТЕЛЬ ЗАБЛОКИРОВАН
   ❌ ПОСТОЯННЫЕ ОШИБКИ В ЛОГАХ
   ❌ ПЛОХОЙ UX
```

## Желаемая ситуация (РЕШЕНИЕ)

```
┌─────────────────┐    JWT Token (60 min)    ┌─────────────────┐
│   Web Client    │ ────────────────────────► │   API Server    │
│                 │                           │                 │
│ - Сохраняет     │                           │ - Валидирует    │
│   токен в       │                           │   токен         │
│   localStorage  │                           │ - Возвращает    │
│                 │                           │   401 при       │
│ - Проверяет     │                           │   истечении     │
│   время         │                           │                 │
│   истечения     │                           │                 │
│                 │                           │                 │
│ - Автоматически │                           │                 │
│   обновляет     │                           │                 │
│   токен         │                           │                 │
│                 │                           │                 │
│ - Обрабатывает  │◄─────────────────────────│                 │
│   401 ошибки    │       401 Unauthorized    │                 │
│                 │                           │                 │
│                 │    Refresh Token (7 days) │                 │
│                 │ ────────────────────────► │                 │
│                 │                           │                 │
│                 │    New JWT Token          │                 │
│                 │ ◄─────────────────────────│                 │
└─────────────────┘                           └─────────────────┘
        │
        ▼
   ✅ АВТОМАТИЧЕСКОЕ ОБНОВЛЕНИЕ ТОКЕНОВ
   ✅ НЕТ ОШИБОК В ЛОГАХ
   ✅ ОТЛИЧНЫЙ UX
```

## Поток обработки токенов (РЕШЕНИЕ)

```
1. Пользователь логинится
   ├─ Получает JWT токен (60 мин) + Refresh токен (7 дней)
   └─ Сохраняет в localStorage

2. При каждом API запросе
   ├─ Проверяет время истечения JWT токена
   ├─ Если токен скоро истечет (< 5 мин) → обновляет через refresh
   └─ Если токен валиден → использует его

3. При получении 401 ошибки
   ├─ Пытается обновить токен через refresh
   ├─ Если успешно → повторяет запрос с новым токеном
   └─ Если не удалось → редирект на страницу входа

4. При истечении refresh токена
   └─ Принудительный logout и редирект на страницу входа
```

## Ключевые изменения

### 1. API сторона (минимальные изменения)
- Увеличить `ExpireMinutes` с 15 до 60
- Добавить endpoint для refresh токенов (если нет)

### 2. Клиентская сторона (основные изменения)
- Добавить проверку времени истечения токена
- Реализовать автоматическое обновление токенов
- Добавить обработку 401 ошибок
- Улучшить UX при истечении сессии
