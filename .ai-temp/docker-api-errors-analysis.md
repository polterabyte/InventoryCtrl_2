# Анализ ошибок Docker контейнера API

## Систематизация ошибок

### 1. **КРИТИЧЕСКАЯ ПРОБЛЕМА: Истекшие JWT токены**
- **Ошибка**: `IDX10223: Lifetime validation failed. The token is expired`
- **Детали**: 
  - Токен истек: `ValidTo (UTC): '09/22/2025 19:09:56'`
  - Текущее время: `Current time (UTC): '09/23/2025 04:52:52'`
  - Токен истек примерно 9 часов назад
- **Затронутые эндпоинты**:
  - `/api/dashboard/low-stock-products`
  - `/api/dashboard/recent-activity`
  - `/api/dashboard/stats`
- **Частота**: Постоянно повторяющиеся ошибки каждые несколько секунд

### 2. **ПРЕДУПРЕЖДЕНИЯ (не критичные)**
- **Static Files Warning**: `The WebRootPath was not found: /app/wwwroot`
- **Data Protection Warning**: `Storing keys in a directory '/root/.aspnet/DataProtection-Keys' that may not be persisted`
- **HTTP Ports Warning**: `Overriding HTTP_PORTS '8080' and HTTPS_PORTS ''`

## Корень проблемы

### Основная причина: Неправильная обработка истекших токенов

1. **Короткий срок жизни токенов**: JWT токены настроены на 15 минут (`ExpireMinutes: 15`)
2. **Отсутствие автоматического обновления токенов**: Клиентское приложение не обновляет токены автоматически
3. **Неправильная обработка 401 ошибок**: При получении 401 ошибки клиент не пытается обновить токен
4. **Отсутствие refresh token логики**: Хотя refresh токены настроены (7 дней), они не используются

### Технические детали

1. **API сторона**:
   - `AuthenticationMiddleware.cs` правильно валидирует токены
   - При истечении токена возвращает 401 ошибку
   - Нет логики для автоматического обновления токенов

2. **Клиентская сторона**:
   - `CustomAuthenticationStateProvider.cs` только сохраняет/загружает токены
   - `WebBaseApiService.cs` не обрабатывает 401 ошибки для обновления токенов
   - `ResilientApiService.cs` не имеет логики для refresh токенов

## Пошаговый план устранения

### Этап 1: Немедленные действия (без изменения кода)

1. **Очистить истекшие токены в браузере**:
   ```javascript
   // Выполнить в консоли браузера
   localStorage.removeItem('authToken');
   localStorage.removeItem('refreshToken');
   ```

2. **Перезапустить клиентское приложение**:
   - Обновить страницу в браузере
   - Или перезапустить Docker контейнер web клиента

### Этап 2: Краткосрочные исправления (требуют изменения кода)

1. **Увеличить срок жизни JWT токенов**:
   - Изменить `ExpireMinutes` с 15 на 60 минут в `appsettings.json`
   - Это даст больше времени для работы без частых обновлений

2. **Добавить обработку 401 ошибок в API клиент**:
   - Модифицировать `WebBaseApiService.cs` для автоматического обновления токенов
   - При получении 401 ошибки попытаться обновить токен через refresh token

3. **Улучшить логику refresh токенов**:
   - Добавить проверку времени истечения токена перед запросами
   - Реализовать автоматическое обновление токенов

### Этап 3: Долгосрочные улучшения

1. **Реализовать полноценную систему refresh токенов**:
   - Добавить endpoint для обновления токенов в API
   - Реализовать автоматическое обновление в клиенте
   - Добавить обработку ошибок refresh токенов

2. **Улучшить обработку ошибок аутентификации**:
   - Добавить пользовательские уведомления об истечении сессии
   - Реализовать автоматический редирект на страницу входа

3. **Добавить мониторинг токенов**:
   - Логирование времени истечения токенов
   - Метрики успешности обновления токенов

## Рекомендуемые изменения конфигурации

### 1. Изменить настройки JWT в `appsettings.json`:
```json
{
  "Jwt": {
    "Key": "__SET_IN_ENV__",
    "Issuer": "InventoryServer",
    "Audience": "InventoryClient",
    "ExpireMinutes": 60,  // Увеличить с 15 до 60
    "RefreshTokenExpireDays": 7
  }
}
```

### 2. Добавить настройки для автоматического обновления токенов:
```json
{
  "Jwt": {
    "AutoRefreshThresholdMinutes": 5,  // Обновлять токен за 5 минут до истечения
    "RefreshRetryAttempts": 3
  }
}
```

## Ожидаемый результат

После реализации исправлений:
1. Ошибки истекших токенов исчезнут из логов
2. Пользователи смогут работать без прерываний сессии
3. Система будет автоматически обновлять токены
4. Улучшится пользовательский опыт
